<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alpha Wulf V1</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #ffd700;
            overflow-x: hidden;
            min-height: 100vh;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .container {
            max-width: 100vw;
            margin: 0 auto;
            padding: 10px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            padding: 20px 0;
            position: relative;
        }

        .loading-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 215, 0, 0.2);
            border: 2px solid #ffd700;
            border-radius: 20px;
            padding: 5px 15px;
            font-size: 12px;
            display: none;
        }

        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 10px;
            background: radial-gradient(circle, #ffd700 0%, #ffed4e 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: #1a1a1a;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .subtitle {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 20px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #ffd700;
            border-radius: 15px;
            padding: 15px 10px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
        }

        .energy-bar {
            width: 100%;
            height: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 30px;
            overflow: hidden;
            border: 2px solid #ffd700;
        }

        .energy-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700 0%, #ffed4e 100%);
            border-radius: 8px;
            transition: width 0.3s ease;
            position: relative;
        }

        .tap-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
        }

        .wolf-coin {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: radial-gradient(circle, #ffd700 0%, #ffed4e 50%, #ffa500 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            color: #1a1a1a;
            cursor: pointer;
            transition: all 0.1s ease;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
            border: 4px solid #ffd700;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .wolf-coin:active {
            transform: scale(0.95);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }

        .navigation {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #ffd700;
            border-radius: 20px;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: auto;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 5px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
            border: none;
            color: #ffd700;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(255, 215, 0, 0.2);
            transform: translateY(-2px);
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .nav-label {
            font-size: 10px;
            text-align: center;
        }

        .section {
            display: none;
            flex: 1;
            padding: 20px 0;
        }

        .section.active {
            display: block;
        }

        .section-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .upgrade-card, .referral-card, .withdrawal-card {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #ffd700;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .upgrade-card:hover, .referral-card:hover, .withdrawal-card:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: translateY(-2px);
        }

        .upgrade-header, .referral-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .upgrade-icon, .referral-icon {
            width: 40px;
            height: 40px;
            background: #ffd700;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: #1a1a1a;
            font-size: 20px;
        }

        .upgrade-info, .referral-info {
            flex: 1;
        }

        .upgrade-name, .referral-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .upgrade-description, .referral-description {
            font-size: 12px;
            opacity: 0.8;
        }

        .upgrade-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .upgrade-stat {
            text-align: center;
        }

        .upgrade-stat-label {
            font-size: 10px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .upgrade-stat-value {
            font-size: 16px;
            font-weight: bold;
        }

        .upgrade-button, .referral-button, .withdrawal-button {
            width: 100%;
            background: linear-gradient(90deg, #ffd700 0%, #ffed4e 100%);
            color: #1a1a1a;
            border: none;
            border-radius: 10px;
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upgrade-button:hover, .referral-button:hover, .withdrawal-button:hover {
            background: linear-gradient(90deg, #ffed4e 0%, #ffd700 100%);
            transform: translateY(-2px);
        }

        .upgrade-button:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
            transform: none;
        }

        .error-message, .success-message {
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }

        .error-message {
            background: rgba(255, 0, 0, 0.2);
            border: 2px solid #ff0000;
            color: #ff6666;
        }

        .success-message {
            background: rgba(0, 255, 0, 0.2);
            border: 2px solid #00ff00;
            color: #66ff66;
        }

        .referral-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .referral-stat {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #ffd700;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .referral-stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .referral-stat-label {
            font-size: 12px;
            opacity: 0.8;
        }

        .referral-link {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #ffd700;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            word-break: break-all;
            font-size: 12px;
        }

        .withdrawal-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .withdrawal-option {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #ffd700;
            border-radius: 10px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .withdrawal-option:hover, .withdrawal-option.selected {
            background: rgba(255, 215, 0, 0.3);
            transform: translateY(-2px);
        }

        .withdrawal-amount {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .withdrawal-value {
            font-size: 12px;
            opacity: 0.8;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: bold;
        }

        .input-field {
            width: 100%;
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #ffd700;
            border-radius: 10px;
            padding: 12px;
            color: #ffd700;
            font-size: 16px;
        }

        .input-field::placeholder {
            color: rgba(255, 215, 0, 0.5);
        }

        .withdrawal-summary {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #ffd700;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .summary-row:last-child {
            margin-bottom: 0;
            font-weight: bold;
            font-size: 18px;
        }

        .footer {
            text-align: center;
            padding: 20px 0;
            font-size: 12px;
            opacity: 0.6;
        }

        @media (max-width: 480px) {
            .stats-container {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            
            .stat-card {
                padding: 10px 5px;
            }
            
            .stat-value {
                font-size: 16px;
            }
            
            .wolf-coin {
                width: 150px;
                height: 150px;
                font-size: 45px;
            }
            
            .navigation {
                grid-template-columns: repeat(5, 1fr);
                gap: 5px;
                padding: 10px;
            }
            
            .nav-item {
                padding: 8px 3px;
            }
            
            .nav-icon {
                font-size: 16px;
            }
            
            .nav-label {
                font-size: 9px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="loading-indicator" id="loadingIndicator">Loading... ID: <span id="loadingId">-</span></div>
            <div class="logo">üê∫</div>
            <div class="title">Alpha Wulf</div>
            <div class="subtitle">Tap to Earn Wolf Coins</div>
        </div>

        <!-- Home Section -->
        <div id="homeSection" class="section active">
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-value" id="coinsDisplay">0</div>
                    <div class="stat-label">ü™ô Coins</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="energyDisplay">0/100</div>
                    <div class="stat-label">‚ö° Energy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="powerDisplay">1</div>
                    <div class="stat-label">üëä Power</div>
                </div>
            </div>

            <div class="energy-bar">
                <div class="energy-fill" id="energyBar" style="width: 100%"></div>
            </div>

            <div class="tap-area">
                <div class="wolf-coin" id="wolfCoin">üê∫</div>
            </div>
        </div>

        <!-- Upgrades Section -->
        <div id="upgradesSection" class="section">
            <div class="section-title">Upgrades</div>
            <div id="upgradesContainer">
                <!-- Upgrades will be loaded here -->
            </div>
        </div>

        <!-- Games Section -->
        <div id="gamesSection" class="section">
            <div class="section-title">Mini Games</div>
            <div class="referral-card">
                <div class="referral-header">
                    <div class="referral-icon">üéÆ</div>
                    <div class="referral-info">
                        <div class="referral-title">Coming Soon</div>
                        <div class="referral-description">Exciting mini games are on the way!</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Withdraw Section -->
        <div id="withdrawSection" class="section">
            <div class="section-title">Withdraw</div>
            
            <div class="withdrawal-card">
                <div style="background: rgba(255, 215, 0, 0.1); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                    <div style="font-size: 12px; margin-bottom: 10px;">
                        ‚Ä¢ Processing time: 24-48 hours<br>
                        ‚Ä¢ UPI transfers are instant once processed<br>
                        ‚Ä¢ Withdrawal fee: 2% of amount
                    </div>
                </div>

                <div class="input-group">
                    <div class="input-label">üí∞ Withdrawal Amount</div>
                    <div class="withdrawal-options" id="withdrawalOptions">
                        <div class="withdrawal-option" data-coins="1000" data-rupees="10">
                            <div class="withdrawal-amount">1,000</div>
                            <div class="withdrawal-value">‚Çπ10</div>
                        </div>
                        <div class="withdrawal-option" data-coins="2500" data-rupees="25">
                            <div class="withdrawal-amount">2,500</div>
                            <div class="withdrawal-value">‚Çπ25</div>
                        </div>
                        <div class="withdrawal-option" data-coins="5000" data-rupees="50">
                            <div class="withdrawal-amount">5,000</div>
                            <div class="withdrawal-value">‚Çπ50</div>
                        </div>
                        <div class="withdrawal-option" data-coins="10000" data-rupees="100">
                            <div class="withdrawal-amount">10,000</div>
                            <div class="withdrawal-value">‚Çπ100</div>
                        </div>
                        <div class="withdrawal-option" data-coins="25000" data-rupees="250">
                            <div class="withdrawal-amount">25,000</div>
                            <div class="withdrawal-value">‚Çπ250</div>
                        </div>
                        <div class="withdrawal-option" data-coins="50000" data-rupees="500">
                            <div class="withdrawal-amount">50,000</div>
                            <div class="withdrawal-value">‚Çπ500</div>
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <div class="input-label">Custom Amount (coins)</div>
                    <input type="number" class="input-field" id="customAmount" placeholder="Enter amount in coins" min="1000">
                </div>

                <div class="input-group">
                    <div class="input-label">UPI ID</div>
                    <input type="text" class="input-field" id="upiId" placeholder="yourname@paytm / yourname@gpay">
                </div>

                <div class="withdrawal-summary" id="withdrawalSummary" style="display: none;">
                    <div class="summary-row">
                        <span>Coins to withdraw:</span>
                        <span id="summaryCoins">0</span>
                    </div>
                    <div class="summary-row">
                        <span>Conversion rate:</span>
                        <span id="summaryRate">‚Çπ0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Processing fee (2%):</span>
                        <span id="summaryFee">‚Çπ0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>You will receive:</span>
                        <span id="summaryFinal">‚Çπ0.00</span>
                    </div>
                </div>

                <button class="withdrawal-button" id="processWithdrawal">Process Withdrawal</button>
            </div>

            <div class="withdrawal-card">
                <div class="referral-header">
                    <div class="referral-icon">üìä</div>
                    <div class="referral-info">
                        <div class="referral-title">Withdrawal History</div>
                        <div class="referral-description">Your previous withdrawal requests</div>
                    </div>
                </div>
                <div id="withdrawalHistory">
                    <div style="text-align: center; padding: 20px; opacity: 0.6;">
                        No withdrawals yet
                    </div>
                </div>
            </div>
        </div>

        <!-- Referrals Section -->
        <div id="referralsSection" class="section">
            <div class="section-title">Referrals</div>
            
            <div class="referral-stats">
                <div class="referral-stat">
                    <div class="referral-stat-value" id="referralCount">0</div>
                    <div class="referral-stat-label">Total Referrals</div>
                </div>
                <div class="referral-stat">
                    <div class="referral-stat-value" id="referralEarnings">0</div>
                    <div class="referral-stat-label">Coins Earned</div>
                </div>
            </div>

            <div class="referral-card">
                <div class="referral-header">
                    <div class="referral-icon">üîó</div>
                    <div class="referral-info">
                        <div class="referral-title">Your Referral Link</div>
                        <div class="referral-description">Share this link to earn 100 coins per referral</div>
                    </div>
                </div>
                <div class="referral-link" id="referralLink">
                    Loading referral link...
                </div>
                <button class="referral-button" id="shareReferral">Share Referral Link</button>
            </div>

            <div class="referral-card">
                <div class="referral-header">
                    <div class="referral-icon">üë•</div>
                    <div class="referral-info">
                        <div class="referral-title">Referred Users</div>
                        <div class="referral-description">Users who joined using your link</div>
                    </div>
                </div>
                <div id="referredUsers">
                    <div style="text-align: center; padding: 20px; opacity: 0.6;">
                        No referrals yet
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Section -->
        <div id="statsSection" class="section">
            <div class="section-title">Statistics</div>
            
            <div class="referral-stats">
                <div class="referral-stat">
                    <div class="referral-stat-value" id="totalTaps">0</div>
                    <div class="referral-stat-label">Total Taps</div>
                </div>
                <div class="referral-stat">
                    <div class="referral-stat-value" id="totalCoinsEarned">0</div>
                    <div class="referral-stat-label">Coins Earned</div>
                </div>
            </div>

            <div class="referral-card">
                <div class="referral-header">
                    <div class="referral-icon">üìà</div>
                    <div class="referral-info">
                        <div class="referral-title">Game Progress</div>
                        <div class="referral-description">Your current game statistics</div>
                    </div>
                </div>
                <div class="referral-stats">
                    <div class="referral-stat">
                        <div class="referral-stat-value" id="currentLevel">1</div>
                        <div class="referral-stat-label">Current Level</div>
                    </div>
                    <div class="referral-stat">
                        <div class="referral-stat-value" id="upgradesPurchased">0</div>
                        <div class="referral-stat-label">Upgrades</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="navigation">
            <button class="nav-item active" data-section="homeSection">
                <div class="nav-icon">üè†</div>
                <div class="nav-label">Home</div>
            </button>
            <button class="nav-item" data-section="upgradesSection">
                <div class="nav-icon">‚¨ÜÔ∏è</div>
                <div class="nav-label">Upgrades</div>
            </button>
            <button class="nav-item" data-section="gamesSection">
                <div class="nav-icon">üéÆ</div>
                <div class="nav-label">Games</div>
            </button>
            <button class="nav-item" data-section="withdrawSection">
                <div class="nav-icon">üí≥</div>
                <div class="nav-label">Withdraw</div>
            </button>
            <button class="nav-item" data-section="referralsSection">
                <div class="nav-icon">üë•</div>
                <div class="nav-label">Referrals</div>
            </button>
        </div>

        <div class="footer">
            @alphawolftesting_bot
        </div>
    </div>

    <script>
        // Global variables
        let userData = {
            telegram_id: null,
            username: null,
            first_name: null,
            coins: 2500,
            energy: 100,
            max_energy: 100,
            tap_power: 1,
            energy_regen_rate: 1,
            last_energy_update: Date.now(),
            referral_count: 0,
            referral_earnings: 0,
            upi_id: null
        };

        let gameStats = {
            totalTaps: 0,
            totalCoinsEarned: 0,
            upgradesPurchased: 0
        };

        let isDataLoaded = false;
        let saveInterval;
        let energyInterval;
        let loadingAttempts = 0;
        const MAX_LOADING_ATTEMPTS = 10;

        // API Configuration
        const API_BASE = "https://alphawulf-backend-gfgy.onrender.com/api";

        // Initialize Telegram WebApp
        function initializeTelegramWebApp() {
            try {
                console.log("Initializing Telegram WebApp...");
                
                if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
                    console.log("Telegram WebApp available");
                    
                    // Configure WebApp
                    Telegram.WebApp.ready();
                    Telegram.WebApp.expand();
                    
                    // Configure back button
                    Telegram.WebApp.BackButton.onClick(() => {
                        console.log("Back button clicked");
                        // Navigate to home section instead of closing
                        showSection('homeSection');
                    });
                    
                    // Get user data from Telegram
                    const webAppData = Telegram.WebApp.initDataUnsafe;
                    console.log("WebApp initDataUnsafe:", webAppData);
                    
                    if (webAppData && webAppData.user) {
                        const user = webAppData.user;
                        console.log("Telegram user data:", user);
                        
                        userData.telegram_id = user.id.toString();
                        userData.username = user.username || null;
                        userData.first_name = user.first_name || "User";
                        
                        updateLoadingIndicator(`ID: ${userData.telegram_id}`);
                        
                        // Check for referral
                        const startParam = webAppData.start_param;
                        if (startParam && startParam.startsWith('ref_')) {
                            const referrerId = startParam.substring(4);
                            console.log("Referral detected:", referrerId);
                            userData.referred_by = referrerId;
                        }
                        
                        return true;
                    } else {
                        console.warn("No user data in Telegram WebApp");
                        return false;
                    }
                } else {
                    console.warn("Telegram WebApp not available");
                    return false;
                }
            } catch (error) {
                console.error("Error initializing Telegram WebApp:", error);
                return false;
            }
        }

        // Fallback user data loading
        function loadFallbackUserData() {
            console.log("Loading fallback user data...");
            
            // Try to get data from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const telegramId = urlParams.get('telegram_id') || urlParams.get('user_id');
            
            if (telegramId) {
                console.log("Found telegram_id in URL:", telegramId);
                userData.telegram_id = telegramId;
                userData.username = urlParams.get('username') || null;
                userData.first_name = urlParams.get('first_name') || "User";
                updateLoadingIndicator(`ID: ${userData.telegram_id}`);
                return true;
            }
            
            // Try localStorage
            const savedTelegramId = localStorage.getItem('alpha_wulf_telegram_id');
            if (savedTelegramId) {
                console.log("Found telegram_id in localStorage:", savedTelegramId);
                userData.telegram_id = savedTelegramId;
                userData.username = localStorage.getItem('alpha_wulf_username') || null;
                userData.first_name = localStorage.getItem('alpha_wulf_first_name') || "User";
                updateLoadingIndicator(`ID: ${userData.telegram_id}`);
                return true;
            }
            
            // Generate demo ID for testing
            const demoId = Date.now().toString();
            console.log("Generating demo ID:", demoId);
            userData.telegram_id = demoId;
            userData.username = "demo_user";
            userData.first_name = "Demo User";
            updateLoadingIndicator(`Demo ID: ${userData.telegram_id}`);
            
            // Save demo data
            localStorage.setItem('alpha_wulf_telegram_id', userData.telegram_id);
            localStorage.setItem('alpha_wulf_username', userData.username);
            localStorage.setItem('alpha_wulf_first_name', userData.first_name);
            
            return true;
        }

        // Update loading indicator
        function updateLoadingIndicator(text) {
            const indicator = document.getElementById('loadingIndicator');
            const idSpan = document.getElementById('loadingId');
            if (indicator && idSpan) {
                idSpan.textContent = text;
                indicator.style.display = 'block';
            }
        }

        // Hide loading indicator
        function hideLoadingIndicator() {
            const indicator = document.getElementById('loadingIndicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }

        // Load user data from backend
        async function loadUserData() {
            if (!userData.telegram_id) {
                console.error("No telegram_id available");
                return false;
            }

            try {
                console.log("Loading user data from backend...");
                updateLoadingIndicator(`Loading data for ${userData.telegram_id}...`);
                
                const response = await fetch(`${API_BASE}/user/${userData.telegram_id}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log("User data loaded:", data);
                    
                    // Update user data with backend response
                    userData = { ...userData, ...data };
                    
                    // Ensure numerical values are correct types
                    userData.coins = parseInt(userData.coins) || 2500;
                    userData.energy = parseFloat(userData.energy) || 100;
                    userData.max_energy = parseInt(userData.max_energy) || 100;
                    userData.tap_power = parseInt(userData.tap_power) || 1;
                    userData.energy_regen_rate = parseInt(userData.energy_regen_rate) || 1;
                    userData.referral_count = parseInt(userData.referral_count) || 0;
                    userData.referral_earnings = parseInt(userData.referral_earnings) || 0;
                    
                    updateUI();
                    isDataLoaded = true;
                    hideLoadingIndicator();
                    return true;
                } else if (response.status === 404) {
                    // User not found, create new user
                    console.log("User not found, creating new user...");
                    return await createNewUser();
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                
                // Retry logic
                loadingAttempts++;
                if (loadingAttempts < MAX_LOADING_ATTEMPTS) {
                    console.log(`Retrying... Attempt ${loadingAttempts}/${MAX_LOADING_ATTEMPTS}`);
                    updateLoadingIndicator(`Retry ${loadingAttempts}/${MAX_LOADING_ATTEMPTS}...`);
                    setTimeout(() => loadUserData(), 2000);
                    return false;
                } else {
                    console.error("Max loading attempts reached");
                    showError("Failed to load user data. Please refresh the page.");
                    hideLoadingIndicator();
                    return false;
                }
            }
        }

        // Create new user
        async function createNewUser() {
            try {
                console.log("Creating new user...");
                updateLoadingIndicator("Creating new user...");
                
                const newUserData = {
                    telegram_id: userData.telegram_id,
                    username: userData.username,
                    first_name: userData.first_name,
                    coins: 2500, // New user bonus
                    energy: 100,
                    max_energy: 100,
                    tap_power: 1,
                    energy_regen_rate: 1,
                    referred_by: userData.referred_by || null
                };

                const response = await fetch(`${API_BASE}/user/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(newUserData)
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log("New user created:", data);
                    
                    userData = { ...userData, ...data };
                    updateUI();
                    isDataLoaded = true;
                    hideLoadingIndicator();
                    
                    showSuccess("Welcome! You've received 2500 bonus coins!");
                    return true;
                } else {
                    throw new Error(`Failed to create user: ${response.statusText}`);
                }
            } catch (error) {
                console.error("Error creating new user:", error);
                showError("Failed to create user account. Please try again.");
                hideLoadingIndicator();
                return false;
            }
        }

        // Save user progress
        async function saveUserProgress() {
            if (!isDataLoaded || !userData.telegram_id) {
                return;
            }

            try {
                console.log("Saving user progress...");
                
                const saveData = {
                    telegram_id: userData.telegram_id,
                    coins: parseInt(userData.coins),
                    energy: parseFloat(userData.energy),
                    max_energy: parseInt(userData.max_energy),
                    tap_power: parseInt(userData.tap_power),
                    energy_regen_rate: parseInt(userData.energy_regen_rate),
                    last_energy_update: Math.floor(Date.now() / 1000),
                    referral_count: parseInt(userData.referral_count),
                    referral_earnings: parseInt(userData.referral_earnings),
                    upi_id: userData.upi_id
                };

                const response = await fetch(`${API_BASE}/user/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(saveData)
                });

                if (response.ok) {
                    console.log("Progress saved successfully");
                } else {
                    console.error("Failed to save progress:", response.statusText);
                }
            } catch (error) {
                console.error("Error saving progress:", error);
            }
        }

        // Update UI elements
        function updateUI() {
            // Update stats display
            document.getElementById('coinsDisplay').textContent = formatNumber(userData.coins);
            document.getElementById('energyDisplay').textContent = `${Math.floor(userData.energy)}/${userData.max_energy}`;
            document.getElementById('powerDisplay').textContent = userData.tap_power;
            
            // Update energy bar
            const energyPercentage = (userData.energy / userData.max_energy) * 100;
            document.getElementById('energyBar').style.width = `${energyPercentage}%`;
            
            // Update referral stats
            document.getElementById('referralCount').textContent = userData.referral_count;
            document.getElementById('referralEarnings').textContent = formatNumber(userData.referral_earnings);
            
            // Update game stats
            document.getElementById('totalTaps').textContent = formatNumber(gameStats.totalTaps);
            document.getElementById('totalCoinsEarned').textContent = formatNumber(gameStats.totalCoinsEarned);
            document.getElementById('upgradesPurchased').textContent = gameStats.upgradesPurchased;
            
            // Update referral link
            const referralLink = `https://t.me/alphawolftesting_bot?start=ref_${userData.telegram_id}`;
            document.getElementById('referralLink').textContent = referralLink;
        }

        // Format numbers with commas
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // Show error message
        function showError(message) {
            const existingError = document.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(errorDiv, container.firstChild);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // Show success message
        function showSuccess(message) {
            const existingSuccess = document.querySelector('.success-message');
            if (existingSuccess) {
                existingSuccess.remove();
            }
            
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(successDiv, container.firstChild);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // Handle tap action
        async function handleTap() {
            if (!isDataLoaded) {
                showError("Please wait for data to load");
                return;
            }
            
            if (userData.energy < 1) {
                showError("Not enough energy!");
                return;
            }

            // Update local data
            userData.energy -= 1;
            userData.coins += userData.tap_power;
            gameStats.totalTaps += 1;
            gameStats.totalCoinsEarned += userData.tap_power;
            
            // Update UI
            updateUI();
            
            // Add tap animation
            const wolfCoin = document.getElementById('wolfCoin');
            wolfCoin.style.transform = 'scale(0.95)';
            setTimeout(() => {
                wolfCoin.style.transform = 'scale(1)';
            }, 100);
            
            // Save progress (debounced)
            clearTimeout(window.tapSaveTimeout);
            window.tapSaveTimeout = setTimeout(saveUserProgress, 1000);
        }

        // Update energy regeneration
        function updateEnergyRegen() {
            if (!isDataLoaded) return;
            
            const now = Date.now();
            const timeDiff = (now - userData.last_energy_update) / 1000; // seconds
            
            if (timeDiff >= 30) { // Regenerate every 30 seconds
                const energyToAdd = Math.floor(timeDiff / 30) * userData.energy_regen_rate;
                userData.energy = Math.min(userData.max_energy, userData.energy + energyToAdd);
                userData.last_energy_update = now;
                updateUI();
            }
        }

        // Show section
        function showSection(sectionId) {
            // Hide all sections
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => section.classList.remove('active'));
            
            // Show target section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // Update navigation
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            
            const activeNavItem = document.querySelector(`[data-section="${sectionId}"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            }
            
            // Configure back button
            if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
                if (sectionId === 'homeSection') {
                    Telegram.WebApp.BackButton.hide();
                } else {
                    Telegram.WebApp.BackButton.show();
                }
            }
            
            // Load section-specific data
            if (sectionId === 'upgradesSection') {
                loadUpgrades();
            } else if (sectionId === 'withdrawSection') {
                loadWithdrawalHistory();
            } else if (sectionId === 'referralsSection') {
                loadReferredUsers();
            }
        }

        // Load upgrades
        async function loadUpgrades() {
            if (!isDataLoaded) return;
            
            try {
                const response = await fetch(`${API_BASE}/upgrades/${userData.telegram_id}`);
                if (response.ok) {
                    const upgrades = await response.json();
                    displayUpgrades(upgrades);
                } else {
                    console.error("Failed to load upgrades");
                }
            } catch (error) {
                console.error("Error loading upgrades:", error);
            }
        }

        // Display upgrades
        function displayUpgrades(upgrades) {
            const container = document.getElementById('upgradesContainer');
            container.innerHTML = '';
            
            upgrades.forEach(upgrade => {
                const upgradeCard = document.createElement('div');
                upgradeCard.className = 'upgrade-card';
                
                const canAfford = userData.coins >= upgrade.cost;
                const buttonClass = canAfford ? 'upgrade-button' : 'upgrade-button';
                const buttonText = canAfford ? `Upgrade - ${formatNumber(upgrade.cost)} coins` : `Need ${formatNumber(upgrade.cost)} coins`;
                
                upgradeCard.innerHTML = `
                    <div class="upgrade-header">
                        <div class="upgrade-icon">${getUpgradeIcon(upgrade.type)}</div>
                        <div class="upgrade-info">
                            <div class="upgrade-name">${upgrade.name}</div>
                            <div class="upgrade-description">${upgrade.description}</div>
                        </div>
                    </div>
                    <div class="upgrade-stats">
                        <div class="upgrade-stat">
                            <div class="upgrade-stat-label">Current Level</div>
                            <div class="upgrade-stat-value">${upgrade.current_level}</div>
                        </div>
                        <div class="upgrade-stat">
                            <div class="upgrade-stat-label">Next Level</div>
                            <div class="upgrade-stat-value">${upgrade.next_level}</div>
                        </div>
                        <div class="upgrade-stat">
                            <div class="upgrade-stat-label">Effect</div>
                            <div class="upgrade-stat-value">${upgrade.effect}</div>
                        </div>
                    </div>
                    <button class="${buttonClass}" ${!canAfford ? 'disabled' : ''} onclick="purchaseUpgrade('${upgrade.type}', ${upgrade.cost})">
                        ${buttonText}
                    </button>
                `;
                
                container.appendChild(upgradeCard);
            });
        }

        // Get upgrade icon
        function getUpgradeIcon(type) {
            switch (type) {
                case 'tap_power': return 'üêæ';
                case 'max_energy': return '‚ö°';
                case 'energy_regen_rate': return 'üîã';
                default: return '‚¨ÜÔ∏è';
            }
        }

        // Purchase upgrade
        async function purchaseUpgrade(upgradeType, cost) {
            if (!isDataLoaded) {
                showError("Please wait for data to load");
                return;
            }
            
            if (userData.coins < cost) {
                showError("Not enough coins!");
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/upgrade`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        telegram_id: userData.telegram_id,
                        upgrade_type: upgradeType
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        userData.coins = result.coins;
                        
                        // Update user stats based on upgrade type
                        if (upgradeType === 'tap_power') {
                            userData.tap_power += 1;
                        } else if (upgradeType === 'max_energy') {
                            userData.max_energy += 20;
                            userData.energy = Math.min(userData.max_energy, userData.energy + 20);
                        } else if (upgradeType === 'energy_regen_rate') {
                            userData.energy_regen_rate += 1;
                        }
                        
                        gameStats.upgradesPurchased += 1;
                        
                        updateUI();
                        loadUpgrades(); // Reload upgrades
                        showSuccess(`${upgradeType.replace('_', ' ')} upgraded successfully!`);
                    } else {
                        showError(result.message || "Upgrade failed");
                    }
                } else {
                    showError("Failed to purchase upgrade");
                }
            } catch (error) {
                console.error("Error purchasing upgrade:", error);
                showError("Network error. Please try again.");
            }
        }

        // Load withdrawal history
        async function loadWithdrawalHistory() {
            if (!isDataLoaded) return;
            
            try {
                const response = await fetch(`${API_BASE}/withdrawals/${userData.telegram_id}`);
                if (response.ok) {
                    const withdrawals = await response.json();
                    displayWithdrawalHistory(withdrawals);
                } else {
                    console.error("Failed to load withdrawal history");
                }
            } catch (error) {
                console.error("Error loading withdrawal history:", error);
            }
        }

        // Display withdrawal history
        function displayWithdrawalHistory(withdrawals) {
            const container = document.getElementById('withdrawalHistory');
            
            if (withdrawals.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; opacity: 0.6;">No withdrawals yet</div>';
                return;
            }
            
            container.innerHTML = '';
            
            withdrawals.forEach(withdrawal => {
                const withdrawalItem = document.createElement('div');
                withdrawalItem.style.cssText = 'background: rgba(255, 215, 0, 0.1); border: 1px solid #ffd700; border-radius: 10px; padding: 15px; margin-bottom: 10px;';
                
                const statusColor = withdrawal.status === 'completed' ? '#00ff00' : 
                                  withdrawal.status === 'rejected' ? '#ff0000' : '#ffd700';
                
                withdrawalItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-weight: bold;">${formatNumber(withdrawal.amount)} coins</span>
                        <span style="color: ${statusColor}; font-weight: bold;">${withdrawal.status.toUpperCase()}</span>
                    </div>
                    <div style="font-size: 12px; opacity: 0.8;">
                        Amount: ‚Çπ${withdrawal.final_amount}<br>
                        UPI: ${withdrawal.upi_id}<br>
                        Date: ${new Date(withdrawal.created_at).toLocaleDateString()}
                    </div>
                `;
                
                container.appendChild(withdrawalItem);
            });
        }

        // Load referred users
        async function loadReferredUsers() {
            if (!isDataLoaded) return;
            
            try {
                const response = await fetch(`${API_BASE}/referrals/${userData.telegram_id}`);
                if (response.ok) {
                    const referrals = await response.json();
                    displayReferredUsers(referrals);
                } else {
                    console.error("Failed to load referred users");
                }
            } catch (error) {
                console.error("Error loading referred users:", error);
            }
        }

        // Display referred users
        function displayReferredUsers(referrals) {
            const container = document.getElementById('referredUsers');
            
            if (referrals.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; opacity: 0.6;">No referrals yet</div>';
                return;
            }
            
            container.innerHTML = '';
            
            referrals.forEach(referral => {
                const referralItem = document.createElement('div');
                referralItem.style.cssText = 'background: rgba(255, 215, 0, 0.1); border: 1px solid #ffd700; border-radius: 10px; padding: 15px; margin-bottom: 10px;';
                
                referralItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: bold;">${referral.first_name || 'User'}</div>
                            <div style="font-size: 12px; opacity: 0.8;">@${referral.username || 'N/A'}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: bold; color: #00ff00;">+100 coins</div>
                            <div style="font-size: 12px; opacity: 0.8;">${new Date(referral.created_at).toLocaleDateString()}</div>
                        </div>
                    </div>
                `;
                
                container.appendChild(referralItem);
            });
        }

        // Initialize app
        async function initializeApp() {
            console.log("Initializing Alpha Wulf app...");
            
            // Try to initialize Telegram WebApp first
            let telegramInitialized = initializeTelegramWebApp();
            
            // If Telegram initialization failed, try fallback
            if (!telegramInitialized) {
                console.log("Telegram initialization failed, trying fallback...");
                telegramInitialized = loadFallbackUserData();
            }
            
            if (telegramInitialized) {
                // Load user data from backend
                const dataLoaded = await loadUserData();
                
                if (dataLoaded) {
                    // Start intervals
                    saveInterval = setInterval(saveUserProgress, 30000); // Save every 30 seconds
                    energyInterval = setInterval(updateEnergyRegen, 1000); // Update energy every second
                    
                    console.log("App initialized successfully");
                } else {
                    console.error("Failed to load user data");
                }
            } else {
                console.error("Failed to initialize user data");
                showError("Failed to initialize app. Please refresh the page.");
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize app
            initializeApp();
            
            // Tap handler
            document.getElementById('wolfCoin').addEventListener('click', handleTap);
            
            // Navigation handlers
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const sectionId = item.getAttribute('data-section');
                    showSection(sectionId);
                });
            });
            
            // Withdrawal handlers
            document.querySelectorAll('.withdrawal-option').forEach(option => {
                option.addEventListener('click', () => {
                    // Remove previous selection
                    document.querySelectorAll('.withdrawal-option').forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    
                    const coins = parseInt(option.getAttribute('data-coins'));
                    const rupees = parseInt(option.getAttribute('data-rupees'));
                    
                    document.getElementById('customAmount').value = coins;
                    updateWithdrawalSummary(coins);
                });
            });
            
            document.getElementById('customAmount').addEventListener('input', (e) => {
                const amount = parseInt(e.target.value) || 0;
                updateWithdrawalSummary(amount);
                
                // Remove selection from preset options
                document.querySelectorAll('.withdrawal-option').forEach(opt => opt.classList.remove('selected'));
            });
            
            document.getElementById('processWithdrawal').addEventListener('click', processWithdrawal);
            
            // Referral share handler
            document.getElementById('shareReferral').addEventListener('click', () => {
                const referralLink = `https://t.me/alphawolftesting_bot?start=ref_${userData.telegram_id}`;
                
                if (navigator.share) {
                    navigator.share({
                        title: 'Join Alpha Wulf',
                        text: 'Join me in Alpha Wulf and earn Wolf Coins!',
                        url: referralLink
                    });
                } else if (navigator.clipboard) {
                    navigator.clipboard.writeText(referralLink);
                    showSuccess('Referral link copied to clipboard!');
                } else {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = referralLink;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showSuccess('Referral link copied!');
                }
            });
        });

        // Update withdrawal summary
        function updateWithdrawalSummary(coins) {
            if (coins < 1000) {
                document.getElementById('withdrawalSummary').style.display = 'none';
                return;
            }
            
            const rupeeAmount = coins / 100; // 100 coins = 1 rupee
            const fee = rupeeAmount * 0.02; // 2% fee
            const finalAmount = rupeeAmount - fee;
            
            document.getElementById('summaryCoins').textContent = formatNumber(coins);
            document.getElementById('summaryRate').textContent = `‚Çπ${rupeeAmount.toFixed(2)}`;
            document.getElementById('summaryFee').textContent = `‚Çπ${fee.toFixed(2)}`;
            document.getElementById('summaryFinal').textContent = `‚Çπ${finalAmount.toFixed(2)}`;
            
            document.getElementById('withdrawalSummary').style.display = 'block';
        }

        // Process withdrawal
        async function processWithdrawal() {
            if (!isDataLoaded) {
                showError("Please wait for data to load");
                return;
            }
            
            const amount = parseInt(document.getElementById('customAmount').value) || 0;
            const upiId = document.getElementById('upiId').value.trim();
            
            if (amount < 1000) {
                showError("Minimum withdrawal amount is 1,000 coins");
                return;
            }
            
            if (userData.coins < amount) {
                showError("Insufficient coins!");
                return;
            }
            
            if (!upiId) {
                showError("Please enter your UPI ID");
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/withdraw`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        telegram_id: userData.telegram_id,
                        amount: amount,
                        upi_id: upiId
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        userData.coins = result.remaining_coins;
                        userData.upi_id = upiId;
                        
                        updateUI();
                        loadWithdrawalHistory();
                        
                        // Clear form
                        document.getElementById('customAmount').value = '';
                        document.getElementById('withdrawalSummary').style.display = 'none';
                        document.querySelectorAll('.withdrawal-option').forEach(opt => opt.classList.remove('selected'));
                        
                        showSuccess("Withdrawal request submitted successfully!");
                    } else {
                        showError(result.message || "Withdrawal failed");
                    }
                } else {
                    showError("Failed to process withdrawal");
                }
            } catch (error) {
                console.error("Error processing withdrawal:", error);
                showError("Network error. Please try again.");
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (saveInterval) clearInterval(saveInterval);
            if (energyInterval) clearInterval(energyInterval);
            saveUserProgress();
        });
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alpha Wulf - Tap to Earn</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
            color: #FFD700;
            min-height: 100vh;
            overflow-x: hidden;
            user-select: none;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 10px;
            background: url('alpha_wulf_logo.png') center/cover;
            border-radius: 50%;
            border: 3px solid #FFD700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .title {
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 5px;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .subtitle {
            font-size: 14px;
            color: #DAA520;
        }

        .stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            gap: 10px;
        }

        .stat-card {
            flex: 1;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(218, 165, 32, 0.05) 100%);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .stat-label {
            font-size: 12px;
            color: #DAA520;
            margin-top: 5px;
        }

        .energy-bar {
            width: 100%;
            height: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .energy-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFD700 0%, #FFA500 100%);
            transition: width 0.3s ease;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .tap-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
        }

        .tap-button {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(218, 165, 32, 0.1) 100%);
            border: 3px solid #FFD700;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.4);
            margin: 0 auto;
            -webkit-tap-highlight-color: transparent !important;
            -webkit-touch-callout: none !important;
            -webkit-user-select: none !important;
            outline: none !important;
        }

        .tap-button:active {
            transform: scale(0.95);
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.8), inset 0 0 30px rgba(255, 215, 0, 0.2);
        }

        .tap-button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .wolf-icon {
            font-size: 80px;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.5));
        }

        .coin-tap-image {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            object-fit: cover;
            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.8));
            transition: all 0.1s ease;
        }

        .tap-button:active .coin-tap-image {
            transform: scale(0.95);
            filter: drop-shadow(0 0 30px rgba(255, 215, 0, 1));
        }

        .coin-icon-small {
            width: 20px;
            height: 20px;
            vertical-align: middle;
            margin-right: 5px;
        }

        .coin-animation {
            position: absolute;
            font-size: 24px;
            color: #FFD700;
            pointer-events: none;
            animation: coinFloat 1s ease-out forwards;
            background-image: url("wolf_coin_icon.png");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            width: 30px;
            height: 30px;
            text-indent: -9999px; /* Hide text, show image */
        }

        @keyframes coinFloat {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(1.5);
                opacity: 0;
            }
        }

        .bottom-nav {
            display: flex;
            justify-content: space-around;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(0, 0, 0, 0.3) 100%);
            border-radius: 20px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .nav-button {
            background: none;
            border: none;
            color: #FFD700;
            font-size: 12px;
            cursor: pointer;
            padding: 10px;
            border-radius: 10px;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 60px;
        }

        .nav-button:hover {
            background: rgba(255, 215, 0, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(255, 215, 0, 0.2);
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 5px;
            filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.3));
        }

        .error {
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.1) 0%, rgba(139, 0, 0, 0.1) 100%);
            border: 1px solid rgba(255, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin: 20px;
            color: #FFD700;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        /* Loading Screen Styles */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: #FFD700;
        }

        .loading-logo {
            width: 120px;
            height: 120px;
            background: url('alpha_wulf_logo.png') center/cover;
            border-radius: 50%;
            border: 4px solid #FFD700;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6), 
                        0 0 60px rgba(255, 215, 0, 0.4),
                        0 0 90px rgba(255, 215, 0, 0.2);
            animation: logoGlow 2s ease-in-out infinite alternate, logoSpin 4s linear infinite;
            margin-bottom: 30px;
        }

        @keyframes logoGlow {
            0% {
                box-shadow: 0 0 30px rgba(255, 215, 0, 0.6), 
                           0 0 60px rgba(255, 215, 0, 0.4),
                           0 0 90px rgba(255, 215, 0, 0.2);
                transform: scale(1);
            }
            100% {
                box-shadow: 0 0 40px rgba(255, 215, 0, 0.8), 
                           0 0 80px rgba(255, 215, 0, 0.6),
                           0 0 120px rgba(255, 215, 0, 0.4);
                transform: scale(1.05);
            }
        }

        @keyframes logoSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-title {
            font-size: 32px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            margin-bottom: 10px;
            animation: titlePulse 1.5s ease-in-out infinite;
        }

        @keyframes titlePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .loading-subtitle {
            font-size: 16px;
            color: #DAA520;
            margin-bottom: 40px;
            animation: subtitleFade 2s ease-in-out infinite;
        }

        @keyframes subtitleFade {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 0.4; }
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 215, 0, 0.2);
            border-top: 4px solid #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-dots {
            font-size: 18px;
            color: #FFD700;
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        .loading-progress {
            width: 200px;
            height: 4px;
            background: rgba(255, 215, 0, 0.2);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 20px;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #FFD700 0%, #FFA500 100%);
            border-radius: 2px;
            animation: progressFill 3s ease-in-out infinite;
        }

        @keyframes progressFill {
            0% { width: 0%; }
            50% { width: 70%; }
            100% { width: 100%; }
        }

        /* Fade out animation for loading screen */
        .loading.fade-out {
            animation: fadeOut 0.8s ease-out forwards;
        }

        @keyframes fadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; visibility: hidden; }
        }
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
        }

        /* User Profile Icon Styles */
        .user-profile {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #FFD700;
            border-radius: 25px;
            padding: 8px 12px;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            max-width: 200px;
            z-index: 1000;
        }

        .user-profile:hover {
            background: rgba(255, 215, 0, 0.2);
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.5);
            transform: translateY(-2px);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            color: #1a1a1a;
            margin-right: 8px;
            border: 2px solid #FFD700;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .user-name {
            font-size: 12px;
            font-weight: bold;
            color: #FFD700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }

        .user-id {
            font-size: 10px;
            color: #DAA520;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }

        @media (max-width: 480px) {
            .user-profile {
                top: 10px;
                right: 10px;
                padding: 6px 10px;
                max-width: 150px;
            }
            
            .user-avatar {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }
            
            .user-name {
                font-size: 11px;
                max-width: 80px;
            }
            
            .user-id {
                font-size: 9px;
                max-width: 80px;
            }
        }    
            .tap-button {
                width: 180px;
                height: 180px;
            }
            
            .wolf-icon {
                font-size: 70px;
            }
        }

        /* Referrals Section */
        .referrals-container {
            display: none;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .referral-card {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(218, 165, 32, 0.05) 100%);
            border-radius: 15px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .referral-code {
            font-size: 18px;
            font-weight: bold;
            color: #FFD700;
            text-align: center;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border: 1px dashed #FFD700;
        }

        .referral-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .referral-stat {
            text-align: center;
            flex: 1;
        }

        .referral-stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #FFD700;
        }

        .referral-stat-label {
            font-size: 12px;
            color: #DAA520;
        }

        .referral-button {
            background: linear-gradient(135deg, #FFD700 0%, #DAA520 100%);
            border: none;
            border-radius: 10px;
            padding: 12px;
            color: #1a1a1a;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            width: 100%;
        }

        .referral-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }

        .referral-list {
            margin-top: 20px;
        }

        .referral-list-title {
            font-size: 16px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 10px;
            text-align: center;
        }

        .referral-user {
            display: flex;
            align-items: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .referral-user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: #1a1a1a;
            margin-right: 10px;
            border: 2px solid #FFD700;
        }

        .referral-user-name {
            font-size: 14px;
            color: #FFD700;
            flex: 1;
        }

        .referral-user-coins {
            font-size: 14px;
            color: #DAA520;
            display: flex;
            align-items: center;
        }

        .referral-user-coins img {
            width: 15px;
            height: 15px;
            margin-right: 5px;
        }

        .no-referrals {
            text-align: center;
            color: #DAA520;
            font-style: italic;
            padding: 15px;
        }

        /* Upgrades Section */
        .upgrades-container {
            display: none;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .upgrade-card {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(218, 165, 32, 0.05) 100%);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .upgrade-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 215, 0, 0.5);
        }

        .upgrade-info {
            display: flex;
            flex-direction: column;
        }

        .upgrade-name {
            font-size: 18px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 5px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .upgrade-description {
            font-size: 12px;
            color: #DAA520;
            margin-bottom: 10px;
        }

        .upgrade-level {
            font-size: 14px;
            color: #FFD700;
        }

        .upgrade-button {
            background: linear-gradient(135deg, #FFD700 0%, #DAA520 100%);
            border: none;
            border-radius: 10px;
            padding: 10px 15px;
            color: #1a1a1a;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .upgrade-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }

        .upgrade-button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .upgrade-button.disabled {
            background: linear-gradient(135deg, #999999 0%, #666666 100%);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .upgrade-cost {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #DAA520;
            margin-top: 5px;
        }

        .upgrade-cost img {
            width: 15px;
            height: 15px;
            margin-right: 5px;
        }

        /* Games Section */
        .games-container {
            display: none;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .game-card {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(218, 165, 32, 0.05) 100%);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            align-items: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .game-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 215, 0, 0.5);
        }

        .game-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            background: linear-gradient(135deg, #FFD700 0%, #DAA520 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            margin-right: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .game-info {
            flex: 1;
        }

        .game-name {
            font-size: 18px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 5px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .game-description {
            font-size: 12px;
            color: #DAA520;
        }

        .game-button {
            background: linear-gradient(135deg, #FFD700 0%, #DAA520 100%);
            border: none;
            border-radius: 10px;
            padding: 8px 15px;
            color: #1a1a1a;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            margin-left: 10px;
        }

        .game-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }

        .game-button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .coming-soon {
            opacity: 0.6;
            position: relative;
        }

        .coming-soon::after {
            content: 'Coming Soon';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            background: rgba(0, 0, 0, 0.7);
            color: #FFD700;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            border: 1px solid #FFD700;
        }

        /* Withdraw Section */
        .withdraw-container {
            display: none;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .withdraw-card {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(218, 165, 32, 0.05) 100%);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .withdraw-title {
            font-size: 18px;
            font-weight: bold;
            color: #FFD700;
            text-align: center;
            margin-bottom: 15px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .withdraw-balance {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 20px;
        }

        .withdraw-balance img {
            width: 30px;
            height: 30px;
            margin-right: 10px;
        }

        .withdraw-input {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            padding: 12px;
            color: #FFD700;
            font-size: 16px;
            width: 100%;
            margin-bottom: 15px;
            text-align: center;
        }

        .withdraw-input::placeholder {
            color: rgba(255, 215, 0, 0.5);
        }

        .withdraw-button {
            background: linear-gradient(135deg, #FFD700 0%, #DAA520 100%);
            border: none;
            border-radius: 10px;
            padding: 12px;
            color: #1a1a1a;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            width: 100%;
        }

        .withdraw-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }

        .withdraw-button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .withdraw-button.disabled {
            background: linear-gradient(135deg, #999999 0%, #666666 100%);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .withdraw-note {
            font-size: 12px;
            color: #DAA520;
            text-align: center;
            margin-top: 15px;
            font-style: italic;
        }

        .withdraw-history {
            margin-top: 20px;
        }

        .withdraw-history-title {
            font-size: 16px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 10px;
            text-align: center;
        }

        .withdraw-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .withdraw-item-date {
            font-size: 12px;
            color: #DAA520;
        }

        .withdraw-item-amount {
            font-size: 14px;
            color: #FFD700;
            display: flex;
            align-items: center;
        }

        .withdraw-item-amount img {
            width: 15px;
            height: 15px;
            margin-right: 5px;
        }

        .withdraw-item-status {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 10px;
        }

        .withdraw-item-status.pending {
            background: rgba(255, 165, 0, 0.2);
            color: #FFA500;
        }

        .withdraw-item-status.completed {
            background: rgba(0, 255, 0, 0.2);
            color: #00FF00;
        }

        .no-withdrawals {
            text-align: center;
            color: #DAA520;
            font-style: italic;
            padding: 15px;
        }

        /* Back button for sections */
        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: none;
            border: none;
            color: #FFD700;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .back-button:hover {
            background: rgba(255, 215, 0, 0.1);
            transform: translateX(-2px);
        }

        /* Section header */
        .section-header {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }

        .section-title {
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 5px;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .section-subtitle {
            font-size: 14px;
            color: #DAA520;
        }

        /* Main game section */
        #mainSection {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading" class="loading">
            <div class="loading-logo"></div>
            <div class="loading-title">Alpha Wulf</div>
            <div class="loading-subtitle">Connecting to the pack</div>
            <div class="loading-spinner"></div>
            <div class="loading-dots">Loading</div>
            <div class="loading-progress">
                <div class="loading-progress-bar"></div>
            </div>
        </div>

        <!-- Main Game Section -->
        <div id="mainSection" style="display: none;">
            <!-- User Profile Icon -->
            <div class="user-profile" id="userProfile" onclick="showUserStats()">
                <div class="user-avatar" id="userAvatar">?</div>
                <div class="user-info">
                    <div class="user-name" id="userName">Loading...</div>
                    <div class="user-id" id="userId">ID: ---</div>
                </div>
            </div>

            <div class="header">
                <div class="logo"></div>
                <div class="title">Alpha Wulf</div>
                <div class="subtitle">Tap to Earn Wolf Coins</div>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="coins">0</div>
                    <div class="stat-label"><img src="wolf_coin_icon.png" alt="Coins" class="coin-icon-small"> Coins</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="energy">100</div>
                    <div class="stat-label">‚ö° Energy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="tapPower">1</div>
                    <div class="stat-label">üí™ Power</div>
                </div>
            </div>

            <div class="energy-bar">
                <div class="energy-fill" id="energyFill" style="width: 100%"></div>
            </div>

            <div class="tap-area">
                <div class="tap-button" id="tapButton">
                    <img src="wolf_coin_icon.png" alt="Wolf Coin" class="coin-tap-image">
                </div>
            </div>

            <div class="bottom-nav">
                <button class="nav-button" onclick="showSection('upgrades')">
                    <div class="nav-icon">‚¨ÜÔ∏è</div>
                    <div>Upgrades</div>
                </button>
                <button class="nav-button" onclick="showSection('games')">
                    <div class="nav-icon">üéÆ</div>
                    <div>Games</div>
                </button>
                <button class="nav-button" onclick="showSection('withdraw')">
                    <div class="nav-icon">üí≥</div>
                    <div>Withdraw</div>
                </button>
                <button class="nav-button" onclick="showSection('referrals')">
                    <div class="nav-icon">üë•</div>
                    <div>Referrals</div>
                </button>
                <button class="nav-button" onclick="showStats()">
                    <div class="nav-icon">üìä</div>
                    <div>Stats</div>
                </button>
            </div>
        </div>

        <!-- Upgrades Section -->
        <div id="upgradesSection" style="display: none;">
            <button class="back-button" onclick="showSection('main')">‚Üê</button>
            <div class="section-header">
                <div class="section-title">Upgrades</div>
                <div class="section-subtitle">Power Up Your Alpha Wulf</div>
            </div>

            <div class="coin-display">
                <img src="wolf_coin_icon.png" alt="Coins" class="coin-icon">
                <span id="upgradesCoinDisplay">0</span>
            </div>

            <div class="upgrades-container" style="display: flex;">
                <div class="upgrade-card">
                    <div class="upgrade-info">
                        <div class="upgrade-name">Tap Power</div>
                        <div class="upgrade-description">Earn more coins per tap</div>
                        <div class="upgrade-level">Level: <span id="tapPowerLevel">1</span></div>
                        <div class="upgrade-cost">
                            <img src="wolf_coin_icon.png" alt="Coins">
                            <span id="tapPowerCost">1000</span>
                        </div>
                    </div>
                    <button class="upgrade-button" id="tapPowerButton" onclick="upgradeItem('tap_power')">Upgrade</button>
                </div>

                <div class="upgrade-card">
                    <div class="upgrade-info">
                        <div class="upgrade-name">Max Energy</div>
                        <div class="upgrade-description">Increase your energy capacity</div>
                        <div class="upgrade-level">Level: <span id="maxEnergyLevel">1</span></div>
                        <div class="upgrade-cost">
                            <img src="wolf_coin_icon.png" alt="Coins">
                            <span id="maxEnergyCost">2000</span>
                        </div>
                    </div>
                    <button class="upgrade-button" id="maxEnergyButton" onclick="upgradeItem('max_energy')">Upgrade</button>
                </div>

                <div class="upgrade-card">
                    <div class="upgrade-info">
                        <div class="upgrade-name">Energy Regen</div>
                        <div class="upgrade-description">Regenerate energy faster</div>
                        <div class="upgrade-level">Level: <span id="energyRegenLevel">1</span></div>
                        <div class="upgrade-cost">
                            <img src="wolf_coin_icon.png" alt="Coins">
                            <span id="energyRegenCost">1500</span>
                        </div>
                    </div>
                    <button class="upgrade-button" id="energyRegenButton" onclick="upgradeItem('energy_regen')">Upgrade</button>
                </div>
            </div>
        </div>

        <!-- Games Section -->
        <div id="gamesSection" style="display: none;">
            <button class="back-button" onclick="showSection('main')">‚Üê</button>
            <div class="section-header">
                <div class="section-title">Mini Games</div>
                <div class="section-subtitle">Play & Earn More Coins</div>
            </div>

            <div class="games-container" style="display: flex;">
                <div class="game-card coming-soon">
                    <div class="game-icon">üé≤</div>
                    <div class="game-info">
                        <div class="game-name">Wolf Dice</div>
                        <div class="game-description">Roll the dice and multiply your coins</div>
                    </div>
                    <button class="game-button" disabled>Play</button>
                </div>

                <div class="game-card coming-soon">
                    <div class="game-icon">üéØ</div>
                    <div class="game-info">
                        <div class="game-name">Target Hunt</div>
                        <div class="game-description">Test your accuracy and win big</div>
                    </div>
                    <button class="game-button" disabled>Play</button>
                </div>

                <div class="game-card coming-soon">
                    <div class="game-icon">üÉè</div>
                    <div class="game-info">
                        <div class="game-name">Wolf Cards</div>
                        <div class="game-description">Card game with wolf-themed deck</div>
                    </div>
                    <button class="game-button" disabled>Play</button>
                </div>
            </div>
        </div>

        <!-- Withdraw Section -->
        <div id="withdrawSection" style="display: none;">
            <button class="back-button" onclick="showSection('main')">‚Üê</button>
            <div class="section-header">
                <div class="section-title">Withdraw</div>
                <div class="section-subtitle">Cash Out Your Wolf Coins</div>
            </div>

            <div class="withdraw-container" style="display: flex;">
                <div class="withdraw-card">
                    <div class="withdraw-title">Available Balance</div>
                    <div class="withdraw-balance">
                        <img src="wolf_coin_icon.png" alt="Coins">
                        <span id="withdrawBalance">0</span>
                    </div>

                    <input type="number" class="withdraw-input" placeholder="Enter amount to withdraw" id="withdrawAmount">
                    <button class="withdraw-button" id="withdrawButton" onclick="requestWithdraw()">Withdraw to Wallet</button>
                    <div class="withdraw-note">Minimum withdrawal: 10,000 coins. Processing time: 24-48 hours.</div>

                    <div class="withdraw-history">
                        <div class="withdraw-history-title">Withdrawal History</div>
                        <div id="withdrawHistoryList">
                            <div class="no-withdrawals">No withdrawal history yet</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Referrals Section -->
        <div id="referralsSection" style="display: none;">
            <button class="back-button" onclick="showSection('main')">‚Üê</button>
            <div class="section-header">
                <div class="section-title">Referrals</div>
                <div class="section-subtitle">Invite Friends & Earn Together</div>
            </div>

            <div class="referrals-container" style="display: flex;">
                <div class="referral-card">
                    <div class="referral-code" id="referralCode">Loading...</div>
                    <div class="referral-stats">
                        <div class="referral-stat">
                            <div class="referral-stat-value" id="referralCount">0</div>
                            <div class="referral-stat-label">Friends</div>
                        </div>
                        <div class="referral-stat">
                            <div class="referral-stat-value" id="referralEarnings">0</div>
                            <div class="referral-stat-label">Earnings</div>
                        </div>
                    </div>
                    <button class="referral-button" onclick="shareReferralCode()">Share Referral Code</button>

                    <div class="referral-list">
                        <div class="referral-list-title">Your Referrals</div>
                        <div id="referralUsersList">
                            <div class="no-referrals">No referrals yet. Share your code to start earning!</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="error" class="error" style="display: none;">
            <h3>Connection Error</h3>
            <p>Unable to connect to Alpha Wulf servers. Please try again later.</p>
            <button onclick="location.reload()" style="margin-top: 10px; padding: 10px 20px; background: #00BFFF; border: none; border-radius: 5px; color: white; cursor: pointer;">Retry</button>
        </div>
    </div>

    <script>
        // Game state
        let gameState = {
            coins: 0,
            energy: 100,
            maxEnergy: 100,
            tapPower: 1,
            energyRegenRate: 1,
            lastUpdate: Date.now(),
            userId: null,
            referralCode: null,
            referralCount: 0,
            referralEarnings: 0,
            referredUsers: [],
            withdrawHistory: []
        };

        // Current active section
        let currentSection = 'main';

        // Telegram Web App initialization
        let tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
            tg.MainButton.hide();
        }

        // API base URL
        const API_BASE = "https://alphawulf-backend-gfgy.onrender.com/api";

        // Tap queue for batching
        let tapQueue = 0;
        let isSaving = false;
        let saveTimeout;
        let energyRegenInterval;

        // Initialize game with robust error handling
        async function initGame() {
            // Check if already initialized from localStorage
            try {
                const savedState = localStorage.getItem('alphaWulfGameState');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    if (parsedState && parsedState.userId) {
                        console.log('Restoring game state from localStorage');
                        gameState = parsedState;
                        
                        // Refresh user data from backend
                        refreshUserData(gameState.userId);
                        
                        // Update UI immediately with saved data
                        updateUserProfile();
                        updateDisplay();
                        hideLoading();
                        startEnergyRegeneration();
                        return;
                    }
                }
            } catch (e) {
                console.error('Error restoring state from localStorage:', e);
            }
            
            try {
                console.log('Initializing Alpha Wulf game...');
                console.log('Environment:', {
                    isTelegram: !!window.Telegram,
                    hasWebApp: !!window.Telegram?.WebApp,
                    userAgent: navigator.userAgent,
                    origin: window.location.origin
                });

                // Get user data from Telegram
                const telegramUser = tg?.initDataUnsafe?.user;
                console.log('Telegram user data:', telegramUser);
                
                if (!telegramUser) {
                    console.log('No Telegram user found, using test data');
                    // For testing without Telegram
                    gameState.userId = 123456789;
                    gameState.coins = 2500;
                    updateDisplay();
                    hideLoading();
                    startEnergyRegeneration();
                    return;
                }

                console.log('Attempting authentication with backend...');
                
                // Try multiple authentication methods
                let authResponse;
                let authData = {
                    telegram_id: telegramUser.id,
                    username: telegramUser.username,
                    first_name: telegramUser.first_name,
                    last_name: telegramUser.last_name
                };

                try {
                    // Primary authentication attempt
                    authResponse = await fetch(`${API_BASE}/auth`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(authData),
                        mode: 'cors',
                        credentials: 'omit'
                    });
                    console.log('Auth response status:', authResponse.status);
                } catch (fetchError) {
                    console.error('Primary fetch failed:', fetchError);
                    
                    // Fallback: try with different configuration
                    try {
                        authResponse = await fetch(`${API_BASE}/auth`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(authData)
                        });
                        console.log('Fallback auth response status:', authResponse.status);
                    } catch (fallbackError) {
                        console.error('Fallback fetch also failed:', fallbackError);
                        throw new Error('Network connection failed');
                    }
                }
                
                if (!authResponse.ok) {
                    const errorText = await authResponse.text();
                    console.error('Auth error:', errorText);
                    throw new Error(`Failed to authenticate user: ${authResponse.status}`);
                }
                
                authData = await authResponse.json();
                console.log('Auth response:', authData);
                
                if (!authData.success || !authData.user) {
                    throw new Error('Invalid authentication response');
                }
                
                const userData = authData.user;
                
                // Update user profile display
                updateUserProfile(telegramUser, userData);
                
                // Update game state with user data
                gameState = {
                    coins: userData.coins || 2500,
                    energy: userData.energy || 100,
                    maxEnergy: userData.max_energy || 100,
                    tapPower: userData.tap_power || 1,
                    energyRegenRate: userData.energy_regen_rate || 1,
                    lastUpdate: Date.now(),
                    userId: userData.telegram_id,
                    referralCode: userData.referral_code,
                    referralCount: userData.referral_count || 0,
                    referralEarnings: userData.referral_earnings || 0,
                    referredUsers: userData.referred_users || [],
                    withdrawHistory: userData.withdraw_history || [],
                    userInfo: {
                        username: telegramUser.username,
                        firstName: telegramUser.first_name,
                        lastName: telegramUser.last_name,
                        telegramId: telegramUser.id
                    }
                };
                
                // Save to localStorage for persistence
                saveGameState();
                
                console.log('Game state initialized:', gameState);
                updateDisplay();
                hideLoading();
                startEnergyRegeneration();
                
            } catch (error) {
                console.error('Failed to initialize game:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                
                // Try to provide more specific error information
                let errorMessage = 'Unable to connect to Alpha Wulf servers. Please try again later.';
                
                if (error.message.includes('Network connection failed')) {
                    errorMessage = 'Network connection failed. Please check your internet connection and try again.';
                } else if (error.message.includes('Failed to authenticate')) {
                    errorMessage = 'Authentication failed. Please restart the app and try again.';
                }
                
                showError(errorMessage);
                
                // Fallback: Load with default values if authentication fails
                setTimeout(() => {
                    console.log('Loading fallback game state...');
                    gameState.userId = 123456789;
                    gameState.coins = 2500;
                    updateDisplay();
                    hideLoading();
                    startEnergyRegeneration();
                }, 3000);
            }
        }

        // Refresh user data from backend
        async function refreshUserData(telegramId) {
            try {
                const response = await fetch(`${API_BASE}/user/${telegramId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    console.error('Failed to refresh user data:', response.status);
                    return;
                }
                
                const userData = await response.json();
                
                // Update game state with fresh data
                gameState.coins = userData.coins || gameState.coins;
                gameState.energy = userData.energy || gameState.energy;
                gameState.maxEnergy = userData.max_energy || gameState.maxEnergy;
                gameState.tapPower = userData.tap_power || gameState.tapPower;
                gameState.energyRegenRate = userData.energy_regen_rate || gameState.energyRegenRate;
                gameState.referralCode = userData.referral_code || gameState.referralCode;
                gameState.referralCount = userData.referral_count || gameState.referralCount;
                gameState.referralEarnings = userData.referral_earnings || gameState.referralEarnings;
                gameState.referredUsers = userData.referred_users || gameState.referredUsers;
                gameState.withdrawHistory = userData.withdraw_history || gameState.withdrawHistory;
                
                // Save updated state
                saveGameState();
                
                // Update UI
                updateDisplay();
                
                console.log('User data refreshed from backend');
            } catch (error) {
                console.error('Error refreshing user data:', error);
            }
        }

        // Save game state to localStorage
        function saveGameState() {
            try {
                localStorage.setItem('alphaWulfGameState', JSON.stringify(gameState));
                console.log('Game state saved to localStorage');
            } catch (e) {
                console.error('Error saving state to localStorage:', e);
            }
        }

        // Update UI elements
        function updateDisplay() {
            // Update main section stats
            document.getElementById('coins').textContent = gameState.coins.toLocaleString();
            document.getElementById('energy').textContent = `${Math.floor(gameState.energy)}/${gameState.maxEnergy}`;
            document.getElementById('tapPower').textContent = gameState.tapPower;
            
            const energyPercentage = (gameState.energy / gameState.maxEnergy) * 100;
            document.getElementById('energyFill').style.width = `${energyPercentage}%`;
            
            const tapButton = document.getElementById('tapButton');
            if (gameState.energy <= 0) {
                tapButton.classList.add('disabled');
            } else {
                tapButton.classList.remove('disabled');
            }
            
            // Update upgrades section
            document.getElementById('upgradesCoinDisplay').textContent = gameState.coins.toLocaleString();
            document.getElementById('tapPowerLevel').textContent = gameState.tapPower;
            document.getElementById('maxEnergyLevel').textContent = gameState.maxEnergy / 100;
            document.getElementById('energyRegenLevel').textContent = gameState.energyRegenRate;
            
            // Calculate and update upgrade costs
            const tapPowerCost = calculateUpgradeCost('tap_power');
            const maxEnergyCost = calculateUpgradeCost('max_energy');
            const energyRegenCost = calculateUpgradeCost('energy_regen');
            
            document.getElementById('tapPowerCost').textContent = tapPowerCost.toLocaleString();
            document.getElementById('maxEnergyCost').textContent = maxEnergyCost.toLocaleString();
            document.getElementById('energyRegenCost').textContent = energyRegenCost.toLocaleString();
            
            // Update upgrade button states
            const tapPowerButton = document.getElementById('tapPowerButton');
            const maxEnergyButton = document.getElementById('maxEnergyButton');
            const energyRegenButton = document.getElementById('energyRegenButton');
            
            if (gameState.coins < tapPowerCost) {
                tapPowerButton.classList.add('disabled');
                tapPowerButton.disabled = true;
            } else {
                tapPowerButton.classList.remove('disabled');
                tapPowerButton.disabled = false;
            }
            
            if (gameState.coins < maxEnergyCost) {
                maxEnergyButton.classList.add('disabled');
                maxEnergyButton.disabled = true;
            } else {
                maxEnergyButton.classList.remove('disabled');
                maxEnergyButton.disabled = false;
            }
            
            if (gameState.coins < energyRegenCost) {
                energyRegenButton.classList.add('disabled');
                energyRegenButton.disabled = true;
            } else {
                energyRegenButton.classList.remove('disabled');
                energyRegenButton.disabled = false;
            }
            
            // Update withdraw section
            document.getElementById('withdrawBalance').textContent = gameState.coins.toLocaleString();
            const withdrawButton = document.getElementById('withdrawButton');
            if (gameState.coins < 10000) {
                withdrawButton.classList.add('disabled');
                withdrawButton.disabled = true;
            } else {
                withdrawButton.classList.remove('disabled');
                withdrawButton.disabled = false;
            }
            
            // Update withdraw history
            updateWithdrawHistory();
            
            // Update referrals section
            document.getElementById('referralCode').textContent = gameState.referralCode || 'Loading...';
            document.getElementById('referralCount').textContent = gameState.referralCount;
            document.getElementById('referralEarnings').textContent = gameState.referralEarnings.toLocaleString();
            
            // Update referred users list
            updateReferredUsersList();
        }

        // Handle tap with batching
        async function handleTap(event) {
            if (gameState.energy <= 0) return;
            
            // Decrease energy and increase coins
            gameState.energy = Math.max(0, gameState.energy - 1);
            gameState.coins += gameState.tapPower;
            tapQueue++;
            
            // Create coin animation
            createCoinAnimation(event);
            
            // Update UI
            updateDisplay();
            
            // Save state
            saveGameState();
            
            // Debounce saving to backend
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(syncTaps, 1500);
        }

        // Sync taps to backend
        async function syncTaps() {
            if (tapQueue === 0 || isSaving) return;
            
            isSaving = true;
            
            try {
                const tapsToSync = tapQueue;
                tapQueue = 0;
                
                console.log('Syncing taps to backend:', tapsToSync);
                
                const response = await fetch(`${API_BASE}/tap`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        telegram_id: gameState.userId,
                        taps: tapsToSync
                    })
                });
                
                if (!response.ok) {
                    console.error('Failed to sync taps:', response.status);
                    tapQueue += tapsToSync; // Restore taps to queue
                    return;
                }
                
                const data = await response.json();
                
                if (data.success && data.user) {
                    // Update game state with authoritative backend data
                    gameState.coins = data.user.coins;
                    gameState.energy = data.user.energy;
                    gameState.maxEnergy = data.user.max_energy;
                    gameState.tapPower = data.user.tap_power;
                    gameState.energyRegenRate = data.user.energy_regen_rate;
                    gameState.referralCode = data.user.referral_code;
                    gameState.referralCount = data.user.referral_count;
                    gameState.referralEarnings = data.user.referral_earnings;
                    gameState.referredUsers = data.user.referred_users || [];
                    
                    // Save updated state
                    saveGameState();
                    
                    // Update UI
                    updateDisplay();
                    
                    console.log('Taps synced successfully');
                }
            } catch (error) {
                console.error('Error syncing taps:', error);
                tapQueue += tapsToSync; // Restore taps to queue
            } finally {
                isSaving = false;
            }
        }

        // Create coin animation
        function createCoinAnimation(event) {
            const coin = document.createElement('div');
            coin.className = 'coin-animation';
            coin.textContent = `+${gameState.tapPower}`;
            
            const rect = event.target.getBoundingClientRect();
            coin.style.left = (event.clientX - rect.left) + 'px';
            coin.style.top = (event.clientY - rect.top) + 'px';
            
            event.target.appendChild(coin);
            
            setTimeout(() => {
                coin.remove();
            }, 1000);
        }

        // Energy regeneration
        function startEnergyRegeneration() {
            // Clear existing interval if any
            if (energyRegenInterval) {
                clearInterval(energyRegenInterval);
            }
            
            energyRegenInterval = setInterval(() => {
                if (gameState.energy < gameState.maxEnergy) {
                    gameState.energy = Math.min(gameState.maxEnergy, gameState.energy + (gameState.energyRegenRate / 60)); // Convert per minute to per second
                    updateDisplay();
                    saveGameState();
                }
            }, 1000); // Update every second
        }

        // Helper functions
        function updateUserProfile(telegramUser, userData) {
            if (!telegramUser && gameState.userInfo) {
                telegramUser = {
                    id: gameState.userInfo.telegramId,
                    first_name: gameState.userInfo.firstName,
                    username: gameState.userInfo.username
                };
            }
            
            if (!telegramUser) return;
            
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            const userId = document.getElementById('userId');
            
            // Set avatar initial (first letter of first name or username)
            const initial = (telegramUser.first_name || telegramUser.username || 'U').charAt(0).toUpperCase();
            userAvatar.textContent = initial;
            
            // Set display name (prefer first name, fallback to username)
            const displayName = telegramUser.first_name || telegramUser.username || 'User';
            userName.textContent = displayName;
            
            // Set user ID
            userId.textContent = `ID: ${telegramUser.id}`;
        }

        function showUserStats() {
            if (!gameState.userInfo) return;
            
            const stats = `
üë§ User Profile:
Name: ${gameState.userInfo.firstName || 'N/A'} ${gameState.userInfo.lastName || ''}
Username: @${gameState.userInfo.username || 'N/A'}
Telegram ID: ${gameState.userInfo.telegramId}

üéÆ Game Stats:
ü™ô Total Coins: ${gameState.coins.toLocaleString()}
‚ö° Energy: ${Math.floor(gameState.energy)}/${gameState.maxEnergy}
üí™ Tap Power: ${gameState.tapPower}
üîã Energy Regen: ${gameState.energyRegenRate}/min
üë• Referrals: ${gameState.referralCount}
üí∏ Referral Earnings: ${gameState.referralEarnings.toLocaleString()}
            `;
            
            if (tg) {
                tg.showAlert(stats);
            } else {
                alert(stats);
            }
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('mainSection').style.display = 'flex';
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('mainSection').style.display = 'none';
            
            // Create error display if it doesn't exist
            let errorDiv = document.getElementById('error');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.id = 'error';
                errorDiv.className = 'error';
                errorDiv.innerHTML = `
                    <h3>Connection Error</h3>
                    <p>${message}</p>
                    <button onclick="location.reload()">Retry</button>
                `;
                document.querySelector('.container').appendChild(errorDiv);
            }
            errorDiv.style.display = 'block';
        }

        // Show section
        function showSection(section) {
            // Hide all sections
            document.getElementById('mainSection').style.display = 'none';
            document.getElementById('upgradesSection').style.display = 'none';
            document.getElementById('gamesSection').style.display = 'none';
            document.getElementById('withdrawSection').style.display = 'none';
            document.getElementById('referralsSection').style.display = 'none';
            
            // Show selected section
            if (section === 'main') {
                document.getElementById('mainSection').style.display = 'flex';
            } else if (section === 'upgrades') {
                document.getElementById('upgradesSection').style.display = 'block';
            } else if (section === 'games') {
                document.getElementById('gamesSection').style.display = 'block';
            } else if (section === 'withdraw') {
                document.getElementById('withdrawSection').style.display = 'block';
            } else if (section === 'referrals') {
                document.getElementById('referralsSection').style.display = 'block';
            }
            
            // Update current section
            currentSection = section;
            
            // Refresh data when showing a section
            updateDisplay();
            
            // Sync any pending taps
            syncTaps();
        }

        // Calculate upgrade cost based on current level
        function calculateUpgradeCost(upgradeType) {
            const baseCosts = {
                'tap_power': 1000,
                'max_energy': 2000,
                'energy_regen': 1500
            };
            
            let currentLevel;
            
            switch (upgradeType) {
                case 'tap_power':
                    currentLevel = gameState.tapPower;
                    break;
                case 'max_energy':
                    currentLevel = gameState.maxEnergy / 100;
                    break;
                case 'energy_regen':
                    currentLevel = gameState.energyRegenRate;
                    break;
                default:
                    currentLevel = 1;
            }
            
            return Math.floor(baseCosts[upgradeType] * Math.pow(1.5, currentLevel - 1));
        }

        // Upgrade an item
        async function upgradeItem(upgradeType) {
            try {
                // Calculate cost
                const cost = calculateUpgradeCost(upgradeType);
                
                // Check if user has enough coins
                if (gameState.coins < cost) {
                    if (tg) {
                        tg.showAlert('Not enough coins!');
                    } else {
                        alert('Not enough coins!');
                    }
                    return;
                }
                
                // Send upgrade request to backend
                const response = await fetch(`${API_BASE}/upgrade`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        telegram_id: gameState.userId,
                        upgrade_type: upgradeType
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Upgrade error:', errorText);
                    if (tg) {
                        tg.showAlert('Failed to upgrade. Please try again.');
                    } else {
                        alert('Failed to upgrade. Please try again.');
                    }
                    return;
                }
                
                const data = await response.json();
                
                if (data.success && data.user) {
                    // Update game state with new values
                    gameState.coins = data.user.coins;
                    gameState.tapPower = data.user.tap_power;
                    gameState.maxEnergy = data.user.max_energy;
                    gameState.energyRegenRate = data.user.energy_regen_rate;
                    
                    // Save updated state
                    saveGameState();
                    
                    // Update UI
                    updateDisplay();
                    
                    // Show success message
                    if (tg) {
                        tg.showPopup({
                            title: 'Upgrade Successful',
                            message: `You've upgraded your ${upgradeType.replace('_', ' ')}!`,
                            buttons: [{type: 'ok'}]
                        });
                    } else {
                        alert(`Upgrade successful! Your ${upgradeType.replace('_', ' ')} has been upgraded.`);
                    }
                } else {
                    if (tg) {
                        tg.showAlert('Failed to upgrade. Please try again.');
                    } else {
                        alert('Failed to upgrade. Please try again.');
                    }
                }
            } catch (error) {
                console.error('Error upgrading item:', error);
                if (tg) {
                    tg.showAlert('An error occurred. Please try again.');
                } else {
                    alert('An error occurred. Please try again.');
                }
            }
        }

        // Request withdraw
        function requestWithdraw() {
            const amount = parseInt(document.getElementById('withdrawAmount').value);
            
            if (isNaN(amount) || amount < 10000) {
                if (tg) {
                    tg.showAlert('Minimum withdrawal amount is 10,000 coins.');
                } else {
                    alert('Minimum withdrawal amount is 10,000 coins.');
                }
                return;
            }
            
            if (amount > gameState.coins) {
                if (tg) {
                    tg.showAlert('Not enough coins for this withdrawal.');
                } else {
                    alert('Not enough coins for this withdrawal.');
                }
                return;
            }
            
            // In a real implementation, this would send a request to the backend
            if (tg) {
                tg.showConfirm(`Withdraw ${amount.toLocaleString()} coins?`, function(confirmed) {
                    if (confirmed) {
                        // Mock successful withdrawal for now
                        gameState.coins -= amount;
                        
                        // Add to withdraw history
                        const now = new Date();
                        gameState.withdrawHistory.push({
                            date: now.toISOString(),
                            amount: amount,
                            status: 'pending'
                        });
                        
                        // Save state
                        saveGameState();
                        
                        // Update UI
                        updateDisplay();
                        
                        // Clear input
                        document.getElementById('withdrawAmount').value = '';
                        
                        tg.showAlert('Withdrawal request submitted successfully! Processing time: 24-48 hours.');
                    }
                });
            } else {
                if (confirm(`Withdraw ${amount.toLocaleString()} coins?`)) {
                    // Mock successful withdrawal for now
                    gameState.coins -= amount;
                    
                    // Add to withdraw history
                    const now = new Date();
                    gameState.withdrawHistory.push({
                        date: now.toISOString(),
                        amount: amount,
                        status: 'pending'
                    });
                    
                    // Save state
                    saveGameState();
                    
                    // Update UI
                    updateDisplay();
                    
                    // Clear input
                    document.getElementById('withdrawAmount').value = '';
                    
                    alert('Withdrawal request submitted successfully! Processing time: 24-48 hours.');
                }
            }
        }

        // Update withdraw history
        function updateWithdrawHistory() {
            const historyList = document.getElementById('withdrawHistoryList');
            
            if (!gameState.withdrawHistory || gameState.withdrawHistory.length === 0) {
                historyList.innerHTML = '<div class="no-withdrawals">No withdrawal history yet</div>';
                return;
            }
            
            let html = '';
            
            gameState.withdrawHistory.forEach(item => {
                const date = new Date(item.date);
                const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
                
                html += `
                <div class="withdraw-item">
                    <div class="withdraw-item-date">${formattedDate}</div>
                    <div class="withdraw-item-amount">
                        <img src="wolf_coin_icon.png" alt="Coins">
                        ${item.amount.toLocaleString()}
                    </div>
                    <div class="withdraw-item-status ${item.status}">${item.status}</div>
                </div>
                `;
            });
            
            historyList.innerHTML = html;
        }

        // Share referral code
        function shareReferralCode() {
            const code = gameState.referralCode;
            
            if (!code) {
                if (tg) {
                    tg.showAlert('Referral code not available. Please try again later.');
                } else {
                    alert('Referral code not available. Please try again later.');
                }
                return;
            }
            
            const message = `Join me on Alpha Wulf and earn Wolf Coins together! Use my referral code: ${code}`;
            
            if (tg) {
                tg.showPopup({
                    title: 'Share Referral Code',
                    message: message,
                    buttons: [
                        {type: 'close'},
                        {
                            id: 'share',
                            type: 'default',
                            text: 'Share'
                        }
                    ]
                }, function(buttonId) {
                    if (buttonId === 'share') {
                        // Use Telegram's native sharing
                        tg.shareMessage(message);
                    }
                });
            } else {
                // Fallback for non-Telegram environment
                if (navigator.share) {
                    navigator.share({
                        title: 'Alpha Wulf Referral',
                        text: message
                    }).catch(err => {
                        console.error('Share failed:', err);
                        alert(message);
                    });
                } else {
                    alert(message);
                }
            }
        }

        // Update referred users list
        function updateReferredUsersList() {
            const usersList = document.getElementById('referralUsersList');
            
            if (!gameState.referredUsers || gameState.referredUsers.length === 0) {
                usersList.innerHTML = '<div class="no-referrals">No referrals yet. Share your code to start earning!</div>';
                return;
            }
            
            let html = '';
            
            gameState.referredUsers.forEach(user => {
                const initial = (user.name || 'U').charAt(0).toUpperCase();
                
                html += `
                <div class="referral-user">
                    <div class="referral-user-avatar">${initial}</div>
                    <div class="referral-user-name">${user.name || 'User'}</div>
                    <div class="referral-user-coins">
                        <img src="wolf_coin_icon.png" alt="Coins">
                        ${user.earnings ? user.earnings.toLocaleString() : '0'}
                    </div>
                </div>
                `;
            });
            
            usersList.innerHTML = html;
        }

        // Show stats
        function showStats() {
            const stats = `
üê∫ Alpha Wulf Stats üê∫

üí∞ Total Coins: ${gameState.coins.toLocaleString()}
‚ö° Energy: ${Math.floor(gameState.energy)}/${gameState.maxEnergy}
üí™ Tap Power: ${gameState.tapPower}
üîã Energy Regen: ${gameState.energyRegenRate}/min
üë• Referrals: ${gameState.referralCount}
üí∏ Referral Earnings: ${gameState.referralEarnings.toLocaleString()}
            `;
            
            if (tg) {
                tg.showAlert(stats);
            } else {
                alert(stats);
            }
        }

        // Event listeners
        document.getElementById('tapButton').addEventListener('click', handleTap);

        // Disable right-click context menu
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });

        // Disable text selection and drag
        document.addEventListener('selectstart', function(e) {
            e.preventDefault();
            return false;
        });

        // Disable drag
        document.addEventListener('dragstart', function(e) {
            e.preventDefault();
            return false;
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                console.log('Page became visible, refreshing data');
                if (gameState.userId) {
                    refreshUserData(gameState.userId);
                }
            }
        });

        // Handle page show (back navigation)
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                console.log('Page restored from cache, refreshing data');
                if (gameState.userId) {
                    refreshUserData(gameState.userId);
                }
            }
        });

        // Initialize when page loads
        window.addEventListener('load', initGame);
    </script>
</body>
</html>

